# SPDX-FileCopyrightText: 2025 RAprogramm <andrey.rozanov.vl@gmail.com>
#
# SPDX-License-Identifier: MIT

# Codecov configuration for masterror project
# Documentation: https://docs.codecov.com/docs/codecov-yaml

codecov:
  # Require CI to pass before processing coverage
  require_ci_to_pass: no
  # Maximum age of report before expiration
  max_report_age: 12h
  # Default branch for coverage comparison
  branch: main

coverage:
  # Precision for coverage percentage (0-5 decimal places)
  precision: 2
  # Round coverage to nearest value
  round: down
  # Coverage range (red to green)
  range: "95...100"

  status:
    # Project-level coverage status check
    project:
      default:
        # Target coverage percentage (auto = maintain current level)
        target: 95%
        # Allow coverage to drop by max 1% before failing
        threshold: 1%
        # Only post status if coverage changes
        if_ci_failed: error
        # Informational only, don't block PR
        informational: true
        # Compare against base commit
        base: auto

    # Patch-level coverage status check (new code only)
    patch:
      default:
        # Target coverage for new code
        target: 95%
        # Allow some flexibility for new code
        threshold: 5%
        # Only check if patch has changes
        if_not_found: success
        # Informational only, don't block PR
        informational: true

    # Changes status (diff between head and base)
    changes:
      default:
        # Informational about coverage changes
        informational: true

  # Flag-based tracking for different test types
  flags:
    unittests:
      paths:
        - src/
      carryforward: true

    integration:
      paths:
        - tests/
      carryforward: true

    doctests:
      paths:
        - src/
      carryforward: true

  # Component-level coverage tracking
  component_management:
    individual_components:
      - component_id: core
        name: Core Library
        paths:
          - src/lib.rs
          - src/app_error/**
          - src/result_ext.rs

      - component_id: derive
        name: Derive Macros
        paths:
          - masterror-derive/src/**

      - component_id: template
        name: Template Engine
        paths:
          - masterror-template/src/**

  # Ignore these paths from coverage
  ignore:
    - "tests/**/*"
    - "benches/**/*"
    - "examples/**/*"
    - "**/tests.rs"
    - "**/benches.rs"

# Pull request comment configuration
comment:
  # Layout for PR comments (show flags and components)
  layout: "condensed_header, condensed_files, flags, components, condensed_footer"
  # Update existing comment instead of creating new ones
  behavior: default
  # Post comment even if coverage doesn't change
  require_changes: false
  # Require base report for comparison
  require_base: yes
  # Require head report to post comment
  require_head: yes
  # Show project coverage in comment
  hide_project_coverage: false

# GitHub integration settings
github_checks:
  annotations: true
