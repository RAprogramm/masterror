#!/usr/bin/env bash
set -euo pipefail

echo "ðŸ”§ Ensuring nightly rustfmt is available..."
if ! rustup toolchain list | grep -q "^nightly"; then
  rustup toolchain install nightly >/dev/null
fi
rustup component add rustfmt --toolchain nightly >/dev/null

echo "ðŸ§¹ Checking formatting with rustfmt..."
cargo +nightly fmt --all -- --check

echo "ðŸ“œ Checking REUSE compliance..."
if command -v reuse &> /dev/null; then
    reuse lint
else
    echo "âš ï¸  Warning: reuse tool not installed, skipping license compliance check"
    echo "   Install with:"
    echo "   - Arch Linux: paru -S reuse (or sudo pacman -S reuse)"
    echo "   - pip:        pip install reuse"
fi

echo "ðŸ”§ Linting GitHub Actions..."
if command -v actionlint &> /dev/null; then
    actionlint
else
    echo "âš ï¸  Warning: actionlint not installed, skipping Actions linting"
    echo "   Install with:"
    echo "   - Arch Linux: paru -S actionlint"
    echo "   - Go:         go install github.com/rhysd/actionlint/cmd/actionlint@latest"
    echo "   - Homebrew:   brew install actionlint"
fi

echo "ðŸ”’ Checking no_std compatibility..."
cargo check --no-default-features -q
cargo check --no-default-features --features tracing -q
cargo check --no-default-features --features metrics -q
cargo check --no-default-features --features colored -q

echo "ðŸ” Running clippy (all features, all targets)..."
cargo clippy --workspace --all-targets --all-features -- -D warnings

echo "ðŸ§ª Running tests (all features)..."
cargo test -vv

echo "ðŸ›¡ï¸ Running cargo audit..."
if ! command -v cargo-audit >/dev/null 2>&1; then
  cargo install --locked cargo-audit >/dev/null
fi
cargo audit

# Uncomment if you want to validate SQLx offline data
# echo "ðŸ“¦ Validating SQLx prepare..."
# cargo sqlx prepare --check --workspace

# same deterministic env
export TZ=UTC
export LC_ALL=C.UTF-8
export NO_COLOR=1
export CARGO_TERM_COLOR=never
export SOURCE_DATE_EPOCH=0

# Generate
./.github/scripts/gen_readme.sh

# Stage README if changed
if ! git diff --quiet -- README.md; then
  git add README.md
fi

echo "âœ… All checks passed!"

